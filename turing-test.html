<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ BUNKER - Turing Test Protocol</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #00ff88;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bunker-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            padding: 10px 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            backdrop-filter: blur(10px);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff0040;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #00ff88;
        }

        .bunker-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 2px solid #00ff88;
        }

        .bunker-title {
            font-size: 2.5em;
            color: #ff0040;
            text-shadow: 0 0 20px #ff0040;
            margin-bottom: 10px;
            animation: flicker 3s infinite;
        }

        .bunker-subtitle {
            font-size: 1.2em;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .threat-level {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(255, 0, 64, 0.2);
            border: 1px solid #ff0040;
            border-radius: 20px;
            font-weight: bold;
            animation: glow 2s ease-in-out infinite alternate;
        }

        .control-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #00ff88;
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .panel-title {
            color: #00ffff;
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px solid #00ffff;
            padding-bottom: 10px;
        }

        .room-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .btn {
            padding: 12px 20px;
            background: linear-gradient(45deg, #00ff88, #00aa55);
            color: #000;
            border: none;
            border-radius: 5px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff0040, #cc0030);
            color: #fff;
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(255, 0, 64, 0.4);
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .config-input {
            flex: 1;
            padding: 10px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #00ff88;
            border-radius: 3px;
            color: #00ff88;
            font-family: inherit;
        }

        .config-input::placeholder {
            color: rgba(0, 255, 136, 0.5);
        }

        .game-display {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ffff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .conversation-log {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            border: 1px solid #333;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #00ff88;
            background: rgba(0, 255, 136, 0.05);
        }

        .message.human {
            border-left-color: #00ffff;
            background: rgba(0, 255, 255, 0.05);
        }

        .message.ai {
            border-left-color: #ff0040;
            background: rgba(255, 0, 64, 0.05);
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: #00ffff;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #00ff88;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00ffff;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .qr-container {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            display: none;
        }

        .provider-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .provider-btn {
            flex: 1;
            padding: 8px 12px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            border-radius: 3px;
            color: #00ff88;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .provider-btn.active {
            background: #00ff88;
            color: #000;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
            75% { opacity: 0.9; }
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px #ff0040; }
            to { box-shadow: 0 0 20px #ff0040, 0 0 30px #ff0040; }
        }

        .tension-meter {
            width: 100%;
            height: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .tension-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #ffff00, #ff0040);
            width: 0%;
            transition: width 1s ease;
        }

        @media (max-width: 768px) {
            .control-panels {
                grid-template-columns: 1fr;
            }
            
            .bunker-title {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="bunker-container">
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="connection-status">
                <div class="status-indicator" id="connectionIndicator"></div>
                <span id="connectionStatus">DESCONECTADO</span>
                <span id="currentRoomCode"></span>
            </div>
            <div>
                <span>Participantes: <span id="participantsCount">0</span></span>
                <span style="margin-left: 20px;">Tens√£o: <span id="tensionLevel">0</span>%</span>
            </div>
        </div>

        <!-- Header -->
        <div class="bunker-header">
            <h1 class="bunker-title">ü§ñ BUNKER PROTOCOL</h1>
            <div class="bunker-subtitle">Sistema de Detec√ß√£o de Infiltrados Artificiais</div>
            <div class="threat-level">‚ö†Ô∏è AMEA√áA: CR√çTICA</div>
            <div class="tension-meter">
                <div class="tension-fill" id="tensionFill"></div>
            </div>
        </div>

        <!-- Control Panels -->
        <div class="control-panels">
            <!-- Connection Panel -->
            <div class="panel">
                <div class="panel-title">üîê CENTRO DE COMANDO</div>
                <div class="room-controls">
                    <button class="btn" onclick="createRoom()">üèóÔ∏è ESTABELECER NOVO BUNKER</button>
                    <div class="input-group">
                        <input type="text" class="config-input" id="roomCodeInput" placeholder="C√ìDIGO DO BUNKER" maxlength="10">
                        <button class="btn" onclick="joinRoom()">üîì CONECTAR</button>
                    </div>
                    <button class="btn btn-danger" onclick="leaveRoom()">‚ùå EVACUAR BUNKER</button>
                </div>
                
                <div class="qr-container" id="qrContainer">
                    <div id="qrcode"></div>
                    <p style="color: #333; margin-top: 10px;">Escaneie para conectar ao bunker</p>
                </div>
            </div>

            <!-- API Configuration Panel -->
            <div class="panel">
                <div class="panel-title">‚öôÔ∏è CONFIGURA√á√ÉO DA API</div>
                
                <div class="provider-selector">
                    <button class="provider-btn" onclick="selectProvider('groq_llama8b')" id="groq_llama8bBtn">ü¶ô Groq Llama 8B</button>
                    <button class="provider-btn" onclick="selectProvider('groq_llama70b')" id="groq_llama70bBtn">ü¶ô Groq Llama 70B</button>
                    <button class="provider-btn" onclick="selectProvider('groq_gemma')" id="groq_gemmaBtn">üíé Groq Gemma</button>
                </div>
                
                <div style="color: #00ffff; font-size: 0.9em; margin-bottom: 10px;">Configure o sistema de detec√ß√£o de m√°quinas</div>
                <div style="color: #888; font-size: 0.8em; margin-bottom: 15px;">Suas chaves s√£o criptografadas e armazenadas apenas localmente no bunker.</div>
                
                <input type="password" class="config-input" id="apiKeyInput" placeholder="CHAVE DE ACESSO DA API" style="margin-bottom: 10px;">
                <button class="btn" onclick="saveApiKey()">üíæ SALVAR CONFIGURA√á√ÉO</button>
                
                <div style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; color: #00ff88;">
                        <input type="checkbox" id="autoClearCheck" onchange="toggleAutoClear()">
                        <span>Limpeza autom√°tica de conversas</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Game Display -->
        <div class="game-display">
            <div class="panel-title">üì° CENTRAL DE MONITORAMENTO</div>
            
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalMessages">0</div>
                    <div class="stat-label">Transmiss√µes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="humanLikeResponses">0</div>
                    <div class="stat-label">Respostas Humanas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="suspiciousResponses">0</div>
                    <div class="stat-label">Atividade Suspeita</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="survivalTime">00:00:00</div>
                    <div class="stat-label">Tempo de Sobreviv√™ncia</div>
                </div>
            </div>

            <!-- Conversation Log -->
            <div class="conversation-log" id="conversationLog">
                <div class="message">
                    <div class="message-header">üîä COMANDO CENTRAL</div>
                    <div>Sistema inicializado. A cada decis√£o errada, mais vidas s√£o perdidas. Mantenham a vigil√¢ncia. A sobreviv√™ncia da humanidade est√° em suas m√£os.</div>
                </div>
            </div>

            <!-- Message Input -->
            <div class="input-group">
                <input type="text" class="config-input" id="messageInput" placeholder="Digite sua mensagem para an√°lise..." onkeypress="handleKeyPress(event)">
                <button class="btn" onclick="sendMessage()">üì° TRANSMITIR</button>
                <button class="btn btn-danger" onclick="clearConversation()">üóëÔ∏è LIMPAR</button>
            </div>
        </div>
    </div>

    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>

    <script>
        // ================================
        // CONFIGURA√á√ÉO SUPABASE (API REST)
        // ================================
        
        const SUPABASE_URL = 'https://ocqosdtvnsnlwagvofan.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jcW9zZHR2bnNubHdhZ3ZvZmFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1NDI3NzEsImV4cCI6MjA2MjExODc3MX0.SUMylY0oR1GJmrXqd9yhIUtKdInifUsZKt4XUvJN1T8';

        // Cliente Supabase REST customizado
        const supabaseClient = {
            async select(table, query = '*') {
                console.log(`üîç SELECT ${table}: ${query}`);
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=${query}`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`‚úÖ SELECT resultado:`, data);
                return data;
            },
            
            async insert(table, data) {
                console.log(`üìù INSERT ${table}:`, data);
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log(`‚úÖ INSERT resultado:`, result);
                return result;
            },
            
            async update(table, data, filter) {
                console.log(`üîÑ UPDATE ${table} WHERE ${filter}:`, data);
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${filter}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log(`‚úÖ UPDATE resultado:`, result);
                return result;
            }
        };

        // ================================
        // VARI√ÅVEIS GLOBAIS
        // ================================
        
        let gameState = {
            conversations: [],
            currentPhase: 'setup',
            votes: {},
            gameStats: {
                totalMessages: 0,
                humanLikeResponses: 0,
                suspiciousResponses: 0,
                votingRounds: 0
            }
        };
        
        let currentRoom = localStorage.getItem('current_room');
        let isConnected = false;
        let tensionLevel = 0;
        let tensionTimer = null;
        let pollInterval = null;
        let startTime = Date.now();
        let apiProvider = localStorage.getItem('api_provider') || 'groq_llama8b';
        let autoClear = localStorage.getItem('auto_clear') === 'true';

        // ================================
        // SISTEMA DE SALAS (SUPABASE)
        // ================================
        
        async function createRoom() {
            const roomCode = 'BUNKER' + Math.random().toString(36).substr(2, 3).toUpperCase();
            
            try {
                console.log('üèóÔ∏è Criando bunker:', roomCode);
                
                const data = await supabaseClient.insert('turing_rooms', {
                    room_code: roomCode,
                    game_state: gameState,
                    participants: 1
                });

                if (data && !data.error) {
                    currentRoom = roomCode;
                    localStorage.setItem('current_room', roomCode);
                    
                    isConnected = true;
                    document.getElementById('currentRoomCode').textContent = roomCode;
                    updateConnectionStatus();
                    generateQRCode(roomCode);
                    startTensionTimer();
                    startPolling();
                    
                    alert(`üèóÔ∏è BUNKER ESTABELECIDO: ${roomCode}\n\nüì± Use o QR Code ou compartilhe o c√≥digo com outros sobreviventes!`);
                    console.log('‚úÖ Bunker criado com sucesso');
                } else {
                    throw new Error(data.error?.message || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('‚ùå Erro ao criar bunker:', error);
                alert('‚ö†Ô∏è Erro ao estabelecer bunker: ' + error.message);
            }
        }

        async function joinRoom() {
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (!roomCode) {
                alert('‚ö†Ô∏è Digite um c√≥digo de bunker v√°lido!');
                return;
            }
            
            try {
                console.log('üîì Conectando ao bunker:', roomCode);
                
                const data = await supabaseClient.select('turing_rooms', '*');
                const room = data.find(r => r.room_code === roomCode);

                if (!room) {
                    alert('‚ùå Bunker n√£o encontrado! Verifique o c√≥digo ou pe√ßa ao comandante para estabelecer um novo bunker.');
                    return;
                }

                // Atualiza participantes
                await supabaseClient.update('turing_rooms', { 
                    participants: (room.participants || 1) + 1,
                    updated_at: new Date().toISOString()
                }, `room_code=eq.${roomCode}`);

                currentRoom = roomCode;
                localStorage.setItem('current_room', roomCode);
                
                isConnected = true;
                document.getElementById('currentRoomCode').textContent = roomCode;
                updateConnectionStatus();
                generateQRCode(roomCode);
                startTensionTimer();
                startPolling();
                
                gameState = room.game_state || gameState;
                updateGameDisplay();
                
                alert(`üîì CONECTADO AO BUNKER: ${roomCode}\n\n‚úÖ Protocolo de sobreviv√™ncia ativado!`);
                console.log('‚úÖ Conectado com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao conectar:', error);
                alert('‚ö†Ô∏è Erro ao conectar ao bunker: ' + error.message);
            }
        }

        async function leaveRoom() {
            if (!currentRoom) return;
            
            try {
                const data = await supabaseClient.select('turing_rooms', '*');
                const room = data.find(r => r.room_code === currentRoom);

                if (room) {
                    await supabaseClient.update('turing_rooms', { 
                        participants: Math.max(0, (room.participants || 1) - 1),
                        updated_at: new Date().toISOString()
                    }, `room_code=eq.${currentRoom}`);
                }
            } catch (error) {
                console.error('‚ùå Erro ao sair:', error);
            }
            
            currentRoom = null;
            localStorage.removeItem('current_room');
            isConnected = false;
            stopTensionTimer();
            stopPolling();
            
            document.getElementById('currentRoomCode').textContent = '';
            updateConnectionStatus();
            alert('‚ùå EVACUA√á√ÉO COMPLETA. Bunker desconectado.');
        }

        // ================================
        // SISTEMA DE POLLING
        // ================================
        
        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(async () => {
                if (currentRoom) {
                    await syncGameState();
                }
            }, 2000);
            console.log('üì° Polling iniciado');
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
                console.log('üì° Polling parado');
            }
        }

        async function syncGameState() {
            if (!currentRoom) return;
            
            try {
                const data = await supabaseClient.select('turing_rooms', '*');
                const room = data.find(r => r.room_code === currentRoom);
                
                if (room && room.game_state) {
                    const remoteState = room.game_state;
                    if (JSON.stringify(gameState) !== JSON.stringify(remoteState)) {
                        gameState = remoteState;
                        updateGameDisplay();
                    }
                    
                    document.getElementById('participantsCount').textContent = room.participants || 0;
                }
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o:', error);
            }
        }

        async function saveGameState() {
            if (!currentRoom) return;
            
            try {
                await supabaseClient.update('turing_rooms', { 
                    game_state: gameState,
                    updated_at: new Date().toISOString()
                }, `room_code=eq.${currentRoom}`);
            } catch (error) {
                console.error('‚ùå Erro ao salvar estado:', error);
            }
        }

        // ================================
        // SISTEMA DE MENSAGENS E IA
        // ================================

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                alert('‚ö†Ô∏è Digite uma mensagem v√°lida!');
                return;
            }

            const apiKey = getApiKey();
            if (!apiKey) {
                alert('‚ö†Ô∏è Configure sua chave da API primeiro!');
                return;
            }

            // Adiciona mensagem do usu√°rio
            addMessage('human', 'HUMANO', message);
            messageInput.value = '';

            // Simula typing
            const typingMessage = addMessage('ai', 'ANALISANDO...', 'Processando padr√µes neurais...');

            try {
                const response = await callAI(message, apiKey);
                
                // Remove typing e adiciona resposta real
                removeMessage(typingMessage);
                addMessage('ai', 'IA SUSPEITA', response);
                
                // An√°lise autom√°tica
                analyzeResponse(response);
                
                // Atualiza stats
                gameState.gameStats.totalMessages++;
                updateStats();
                updateTension();
                
                // Salva estado se conectado
                if (isConnected) {
                    await saveGameState();
                }
                
            } catch (error) {
                removeMessage(typingMessage);
                addMessage('ai', 'ERRO DE SISTEMA', `Falha na comunica√ß√£o: ${error.message}`);
                console.error('Erro na IA:', error);
            }
        }

        async function callAI(message, apiKey) {
            const providers = {
                groq_llama8b: {
                    url: 'https://api.groq.com/openai/v1/chat/completions',
                    model: 'llama-3.1-8b-instant'
                },
                groq_llama70b: {
                    url: 'https://api.groq.com/openai/v1/chat/completions', 
                    model: 'llama-3.1-70b-versatile'
                },
                groq_gemma: {
                    url: 'https://api.groq.com/openai/v1/chat/completions',
                    model: 'gemma2-9b-it'
                }
            };

            const provider = providers[apiProvider];
            if (!provider) {
                throw new Error('Provedor de IA n√£o configurado');
            }

            const response = await fetch(provider.url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: provider.model,
                    messages: [
                        {
                            role: 'system', 
                            content: 'Voc√™ est√° em um bunker p√≥s-apocal√≠ptico tentando se passar por humano. Responda de forma natural e humana, mas ocasionalmente deixe pequenos ind√≠cios de que voc√™ pode ser uma IA (como conhecimento muito espec√≠fico ou padr√µes de linguagem ligeiramente artificiais). Seja sutil.'
                        },
                        {
                            role: 'user', 
                            content: message
                        }
                    ],
                    max_tokens: 150,
                    temperature: 0.8
                })
            });

            if (!response.ok) {
                throw new Error(`Erro da API: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function addMessage(type, sender, content) {
            const log = document.getElementById('conversationLog');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <div class="message-header">${type === 'human' ? 'üë§' : 'ü§ñ'} ${sender}</div>
                <div>${content}</div>
            `;
            
            log.appendChild(messageDiv);
            log.scrollTop = log.scrollHeight;
            
            // Auto-clear se habilitado
            if (autoClear && log.children.length > 20) {
                log.removeChild(log.firstChild);
            }
            
            return messageDiv;
        }

        function removeMessage(messageElement) {
            if (messageElement && messageElement.parentNode) {
                messageElement.parentNode.removeChild(messageElement);
            }
        }

        function analyzeResponse(response) {
            // An√°lise simples de padr√µes suspeitos
            const suspiciousPatterns = [
                /como uma ia/i,
                /processamento/i,
                /dados/i,
                /algoritmo/i,
                /neural/i,
                /computa√ß√£o/i,
                /sistema/i
            ];
            
            const humanPatterns = [
                /eu sinto/i,
                /tenho medo/i,
                /lembro/i,
                /fam√≠lia/i,
                /amigos/i,
                /sonho/i,
                /cansado/i
            ];
            
            let suspiciousCount = 0;
            let humanCount = 0;
            
            suspiciousPatterns.forEach(pattern => {
                if (pattern.test(response)) suspiciousCount++;
            });
            
            humanPatterns.forEach(pattern => {
                if (pattern.test(response)) humanCount++;
            });
            
            if (suspiciousCount > humanCount) {
                gameState.gameStats.suspiciousResponses++;
                addMessage('system', '‚ö†Ô∏è ALERTA', 'Padr√µes suspeitos detectados na √∫ltima transmiss√£o');
            } else {
                gameState.gameStats.humanLikeResponses++;
            }
        }

        function clearConversation() {
            if (confirm('‚ö†Ô∏è Limpar todo o log de conversas?')) {
                document.getElementById('conversationLog').innerHTML = `
                    <div class="message">
                        <div class="message-header">üîä COMANDO CENTRAL</div>
                        <div>Log limpo. Sistema reinicializado. Mantenham vigil√¢ncia constante.</div>
                    </div>
                `;
                gameState.conversations = [];
                if (isConnected) saveGameState();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ================================
        // CONFIGURA√á√ÉO DE API
        // ================================

        function selectProvider(provider) {
            apiProvider = provider;
            localStorage.setItem('api_provider', provider);
            
            // Atualiza bot√µes
            document.querySelectorAll('.provider-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(provider + 'Btn').classList.add('active');
            
            console.log('üîß Provedor selecionado:', provider);
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                alert('‚ö†Ô∏è Digite uma chave de API v√°lida!');
                return;
            }
            
            // Criptografia simples (base64)
            const encoded = btoa(apiKey);
            localStorage.setItem('api_key_' + apiProvider, encoded);
            
            document.getElementById('apiKeyInput').value = '';
            alert('‚úÖ Chave salva com seguran√ßa no bunker local!');
        }

        function getApiKey() {
            const encoded = localStorage.getItem('api_key_' + apiProvider);
            return encoded ? atob(encoded) : null;
        }

        function toggleAutoClear() {
            autoClear = document.getElementById('autoClearCheck').checked;
            localStorage.setItem('auto_clear', autoClear);
        }

        function loadPersonalitySettings() {
            // Carrega configura√ß√µes salvas
            const savedProvider = localStorage.getItem('api_provider');
            if (savedProvider) {
                selectProvider(savedProvider);
            }
        }

        // ================================
        // SISTEMA DE TENS√ÉO E STATS
        // ================================

        function startTensionTimer() {
            if (tensionTimer) clearInterval(tensionTimer);
            
            tensionTimer = setInterval(() => {
                if (isConnected) {
                    tensionLevel = Math.min(100, tensionLevel + Math.random() * 2);
                } else {
                    tensionLevel = Math.max(0, tensionLevel - 1);
                }
                updateTensionDisplay();
            }, 3000);
        }

        function stopTensionTimer() {
            if (tensionTimer) {
                clearInterval(tensionTimer);
                tensionTimer = null;
            }
        }

        function updateTension() {
            if (gameState.gameStats.suspiciousResponses > gameState.gameStats.humanLikeResponses) {
                tensionLevel = Math.min(100, tensionLevel + 10);
            } else {
                tensionLevel = Math.max(0, tensionLevel - 5);
            }
            updateTensionDisplay();
        }

        function updateTensionDisplay() {
            document.getElementById('tensionLevel').textContent = Math.floor(tensionLevel);
            document.getElementById('tensionFill').style.width = tensionLevel + '%';
        }

        function updateStats() {
            const stats = gameState.gameStats;
            document.getElementById('totalMessages').textContent = stats.totalMessages;
            document.getElementById('humanLikeResponses').textContent = stats.humanLikeResponses;
            document.getElementById('suspiciousResponses').textContent = stats.suspiciousResponses;
            
            // Tempo de sobreviv√™ncia
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('survivalTime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateConnectionStatus() {
            const indicator = document.getElementById('connectionIndicator');
            const status = document.getElementById('connectionStatus');
            
            if (isConnected) {
                indicator.classList.add('connected');
                status.textContent = 'CONECTADO';
            } else {
                indicator.classList.remove('connected');
                status.textContent = 'DESCONECTADO';
            }
        }

        function updateGameDisplay() {
            // Atualiza display baseado no gameState
            updateStats();
            
            // Reconstr√≥i log se necess√°rio
            if (gameState.conversations && gameState.conversations.length > 0) {
                const log = document.getElementById('conversationLog');
                log.innerHTML = '<div class="message"><div class="message-header">üîä COMANDO CENTRAL</div><div>Estado sincronizado com bunker.</div></div>';
                
                gameState.conversations.forEach(conv => {
                    addMessage(conv.type, conv.sender, conv.content);
                });
            }
        }

        // ================================
        // QR CODE E AUTO-JOIN
        // ================================

        function generateQRCode(roomCode) {
            const qrContainer = document.getElementById('qrContainer');
            const qrElement = document.getElementById('qrcode');
            
            // Limpa QR anterior
            qrElement.innerHTML = '';
            
            // URL para auto-join
            const joinUrl = `${window.location.origin}${window.location.pathname}?join=${roomCode}`;
            
            // Verifica se QRCode est√° dispon√≠vel
            if (typeof QRCode !== 'undefined') {
                QRCode.toCanvas(qrElement, joinUrl, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, function(error) {
                    if (error) {
                        console.error('Erro ao gerar QR Code:', error);
                        showQRFallback(qrElement, joinUrl, roomCode);
                    } else {
                        qrContainer.style.display = 'block';
                    }
                });
            } else {
                console.warn('QRCode library n√£o carregada, mostrando fallback');
                showQRFallback(qrElement, joinUrl, roomCode);
            }
        }

        function showQRFallback(element, joinUrl, roomCode) {
            element.innerHTML = `
                <div style="padding: 20px; text-align: center; border: 2px solid #333;">
                    <div style="font-size: 1.2em; margin-bottom: 10px; color: #333;">üì± C√ìDIGO DO BUNKER</div>
                    <div style="font-size: 2em; font-weight: bold; color: #000; margin: 10px 0;">${roomCode}</div>
                    <div style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        Compartilhe este c√≥digo ou link:<br>
                        <a href="${joinUrl}" style="color: #0066cc; word-break: break-all;">${joinUrl}</a>
                    </div>
                </div>
            `;
            document.getElementById('qrContainer').style.display = 'block';
        }

        function checkAutoJoin() {
            const urlParams = new URLSearchParams(window.location.search);
            const joinCode = urlParams.get('join');
            
            if (joinCode) {
                document.getElementById('roomCodeInput').value = joinCode;
                // Auto-join ap√≥s um delay para garantir que tudo carregou
                setTimeout(() => {
                    joinRoom();
                }, 1000);
            }
        }

        // ================================
        // INICIALIZA√á√ÉO
        // ================================

        function init() {
            console.log('üöÄ Iniciando Turing Test App...');
            console.log('‚úÖ Cliente REST personalizado inicializado');
            console.log('üîó URL:', SUPABASE_URL);
            console.log('üîë Key presente:', SUPABASE_ANON_KEY ? 'SIM' : 'N√ÉO');
            
            updateConnectionStatus();
            updateStats();
            loadPersonalitySettings();
            document.getElementById('autoClearCheck').checked = autoClear;
            selectProvider(apiProvider);
            
            // Verifica auto-join via QR Code
            checkAutoJoin();
            
            // Auto-conecta se havia sala (mas s√≥ se for um c√≥digo v√°lido)
            if (currentRoom && currentRoom.startsWith('BUNKER')) {
                console.log('üîÑ Sala anterior encontrada:', currentRoom);
                document.getElementById('roomCodeInput').value = currentRoom;
            }
            
            // Timer para atualizar stats
            setInterval(updateStats, 1000);
            
            // Inicia timer de tens√£o
            startTensionTimer();
            
            console.log('‚úÖ Inicializa√ß√£o completa!');
        }

        // Inicia aplica√ß√£o quando p√°gina carregar
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
